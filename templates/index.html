<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é¸æ“‡è¦è«®å•†çš„è™›æ“¬é†«äº‹äººå“¡</title>
  <link rel="stylesheet" href="static/style.css"/>
  <style>
    .chat-input-container {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
  
    .chat-input-container input[type="text"] {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
  
    .chat-input-container button {
      padding: 10px 14px;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      color: white;
    }
  
    #sendBtn {
      background-color: #007bff;
    }
  
    #sendBtn:hover {
      background-color: #0056b3;
    }
  
    #micBtn {
      background-color: #28a745;
    }
  
    #micBtn:hover {
      background-color: #1e7e34;
    }

    .suggest-btn {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.95rem;
    }

    .suggest-btn:hover {
        background-color: #e0e0e0;
    }

    #downloadBtn {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.95rem;
        white-space: nowrap;
    }

    #downloadBtn {
        background-color: #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- é–‹å•Ÿå´é‚Šæ¬„æŒ‰éˆ• -->
    <button id="toggleSidebarBtn" class="toggle-sidebar">é¸æ“‡è«®å•†äººå“¡</button>

    <aside class="sidebar hidden" id="sidebar">
      <h2>é¸æ“‡è¦è«®å•†çš„è™›æ“¬é†«äº‹äººå“¡</h2>
      <div class="character-list">
        <img src="static/images/male_doctor.jpg" alt="é†«ç”Ÿ 1" class="thumbnail" onclick="selectCharacter(this.src)">
        <b>è—¥åŠ‘å¸«</b>
        <img src="static/images/female_doctor.jpg" alt="é†«ç”Ÿ 2" class="thumbnail" onclick="selectCharacter(this.src)">
        <b>ç‡Ÿé¤Šå¸«</b>
      </div>
    </aside>

    <main class="main-content">
      <div class="selected-character">
        <h2>ç›®å‰é¸æ“‡çš„é†«äº‹äººå“¡</h2>
        <img id="selectedImg" src="static/images/male_doctor.jpg" alt="é¸æ“‡çš„é†«ç”Ÿ">
        <b id="selectedName"></b>
      </div>

      <div class="chat-box">
        <h2>å°è©±ç´€éŒ„</h2>
        <div id="chatLog" class="chat-log">
          <div class="chat-message bot">æ‚¨å¥½ï¼æˆ‘å¯ä»¥ç‚ºæ‚¨æä¾›ä»€éº¼å”åŠ©ï¼Ÿ</div>
        </div>
      </div>

      <div class="controls">
        <div class="chat-input-container">
          <input type="text" id="chatInput" placeholder="è«‹è¼¸å…¥è¨Šæ¯..." />
          <button id="sendBtn">ğŸ“¤ ç™¼é€</button>
          <button id="micBtn">ğŸ¤</button>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <label style="display: flex; align-items: center;">
            <input type="checkbox" id="responseWithAudio" style="margin-right: 0.4rem;">
            Response with audio
          </label>
        
          <button id="downloadBtn">
            Download ChatLog
          </button>
        </div>
        <div id="suggestedQuestions" style="margin-top: 20px;">
          <h3>ğŸ’¡ ä½ å¯ä»¥å•æˆ‘ï¼š</h3>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <button class="suggest-btn">ç³–å°¿ç—…æ˜¯åƒå¤ªå¤šç³–é€ æˆçš„ï¼Ÿ</button>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div id="loadingDialog" style="
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem;
    color: white;
    font-weight: bold;
  ">
    â³ Processing...
  </div>

  <script>
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSidebarBtn');
    const questions = [
      "ç³–å°¿ç—…æ˜¯åƒå¤ªå¤šç³–é€ æˆçš„ï¼Ÿ",
      "ç³–å°¿ç—…æ‚£è€…æ‡‰è©²å°‘åƒç±³é£¯ï¼ˆé†£é¡ï¼‰ã€å¤šåƒè‚‰ï¼ˆè›‹ç™½è³ªï¼‰ï¼Ÿ",
      "ç³–å°¿ç—…æ‚£è€…ä¸èƒ½åƒç”œé£Ÿï¼Œè‹¥ä½¿ç”¨ä»£ç³–å°±å¯ä»¥ï¼Ÿ",
      "å–ç³–å°¿ç—…å°ˆç”¨ç‰›å¥¶æˆ–å¥¶ç²‰å¯ä»¥é™è¡€ç³–ï¼Ÿ",
      "åƒèŠ­æ¨‚ã€ç•ªèŒ„å¯ä»¥é™è¡€ç³–ï¼Ÿ",
      "é»‘ç³–ã€èœ‚èœœåŠæœç³–æ˜¯å¥½ç³–ï¼Œä¸æœƒå½±éŸ¿è¡€ç³–ï¼Ÿ",
      "å–ç§‹è‘µæ°´å¯é™è¡€ç³–ï¼Ÿ",
      "åƒç‡•éº¥ç‰‡å¯ä»¥é™è¡€ç³–ï¼Ÿ",
      "æŠ—æ€§æ¾±ç²‰æ¯”è¼ƒä¸æœƒè®“è¡€ç³–å‡é«˜ï¼Œæ‡‰é¸æ“‡æŠ—æ€§æ¾±ç²‰é£Ÿç‰©ï¼ˆä¾‹å¦‚å†·é£¯ï¼‰ï¼Ÿ",
      "åƒå¤ªå¤šç³–æœƒå¾—ç³–å°¿ç—…ï¼Ÿ",
      "ç³–å°¿ç—…é£²é£Ÿçš„è¦çŸ©å¾ˆå¤šï¼Ÿ",
      "ç¢³æ°´åŒ–åˆç‰©å°ç³–å°¿ç—…ä¸å¥½ï¼Ÿ",
      "å°ç³–å°¿ç—…ä¾†èªªï¼Œè›‹ç™½è³ªæ¯”ç¢³æ°´åŒ–åˆç‰©å¥½ï¼Ÿ",
      "ä¸ç®¡åƒä»€éº¼ï¼Œéƒ½èƒ½ç”¨è—¥ç‰©ä¾†èª¿æ•´ï¼Ÿ",
      "ç½¹æ‚£ç³–å°¿ç—…å¾Œï¼Œå¾—æ”¾æ£„æ‰€æœ‰çš„ç”œé»ï¼Ÿ",
      "äººå·¥ç”œå‘³åŠ‘å°ç³–å°¿ç—…æ‚£è€…å¾ˆå±éšªï¼Ÿ",
      "éœ€è¦åƒç‰¹åˆ¥çš„ç³–å°¿ç—…é¤ï¼Ÿ",
      "æ¸›é‡é£Ÿç‰©æ˜¯ç³–å°¿ç—…æœ€ä½³çš„é¸æ“‡ï¼Ÿ",
      "æ‚£è€…çš„å®¶æ—å²æ˜¯å¥¶å¥¶å’Œçˆ¶è¦ªéƒ½æœ‰ç¬¬2å‹ç³–å°¿ç—…ï¼Œæ‚£è€…éå¸¸æ“”å¿ƒè‡ªå·±ç”¢å¾Œä¹Ÿæœƒå¾å¦Šå¨ ç³–å°¿ç—…è®Šæˆç¬¬2å‹ç³–å°¿ç—…ï¼Œæ€éº¼è¾¦ï¼Ÿ",
      "ç‚ºäº†è¦é¿å…ç½¹æ‚£2å‹ç³–å°¿ç—…ï¼Œæ‚£è€…åœ¨é£²é£Ÿä¸Šè¦ç‰¹åˆ¥æ³¨æ„ä»€éº¼ï¼Ÿ",
      "æœ‰ç¬¬2å‹ç³–å°¿ç—…å®¶æ—å²çš„å¦Šå¨ ç³–å°¿ç—…æ‚£è€…æ‡‰è©²è¦ç‚ºæ­¤è€Œç‰¹æ®Šç”¨è—¥ç‰©ä¾†æ§åˆ¶è¡€ç³–å—ï¼Ÿ",
      "å¦Šå¨ ç³–å°¿ç—…æ‚£è€…çš„ç‡Ÿé¤Šæ²»ç™‚ç›®æ¨™å’Œä¸€èˆ¬æ­£å¸¸çš„å­•å©¦åœ¨é£²é£Ÿä¸Šæœ‰ä»€éº¼è¦ç‰¹åˆ¥æ³¨æ„çš„åœ°æ–¹ï¼Ÿ",
      "å°æ–¼é€™ç¨®æœ‰å®¶æ—å²çš„å¦Šå¨ ç³–å°¿ç—…æ‚£è€…ç‡Ÿé¤Šæ²»ç™‚ç›®æ¨™å¦‚ä½•è¨‚å®šï¼Ÿ",
      "æœ‰å®¶æ—å²çš„å¦Šå¨ ç³–å°¿ç—…æ‚£è€…ç‡Ÿé¤Šæ²»ç™‚ç›®æ¨™å’Œæ²’æœ‰å®¶æ—å²çš„å¦Šå¨ ç³–å°¿ç—…æ‚£è€…çš„ç‡Ÿé¤Šæ²»ç™‚ç›®æ¨™æœ‰ä»€éº¼ä¸åŒï¼Ÿ",
      "å¾æ‚£è€…ç›®å‰çš„é£²é£Ÿå‹æ…‹ï¼Œæ‡‰è©²å»ºè­°æ‚£è€…åšå“ªäº›éœ€è¦å…·é«”æ”¹è®Šçš„é‡é»åœ°æ–¹ï¼Ÿ"
    ];
    const suggestBtn = document.getElementsByClassName("suggest-btn")[0];
  
    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('hidden');
    });
  
    function selectCharacter(src) {
      let role = "unknown";
      if (src.includes("/male_doctor")) {
        role = "doctor";
      } else if (src.includes("/female_doctor")) {
        role = "nutritionist";
      }
      localStorage.setItem("selectedDoctor", src);
      localStorage.setItem("selectedRole", role);
      location.reload();
    }
  
    function appendChatMessage(role, text) {
      const msg = document.createElement("div");
      msg.className = `chat-message ${role}`;
      msg.innerText = text;
      const chatLog = document.getElementById("chatLog");
      chatLog.appendChild(msg);
  
      // Cuá»™n xuá»‘ng sau khi thÃªm tin nháº¯n
      requestAnimationFrame(() => {
        document.getElementsByClassName("chat-box")[0].scrollTop = chatLog.scrollHeight;
      });
    }
  
    document.getElementById("sendBtn").addEventListener("click", async () => {
      const checkbox = document.getElementById("responseWithAudio");
      const responseWithAudio = checkbox.checked; // true náº¿u Ä‘Æ°á»£c tick
      const input = document.getElementById("chatInput");
      const text = input.value.trim();
        
      if (text) {
        document.getElementById("loadingDialog").style.display = "flex";
        appendChatMessage("user", text);
        input.value = "";
        const formData = new FormData();
        formData.append("question", text);
        const selectedRole = localStorage.getItem("selectedRole") || "unknown";
        formData.append("role", selectedRole);
        console.log(selectedRole)
        formData.append("responseWithAudio", responseWithAudio);
        const response = await fetch("https://em62pxdlbjubuw.api.runpod.ai/ask", {
          method: "POST",
          headers: {
          
          },
          body: formData
        });

        // appendChatMessage("bot", "è¬è¬æ‚¨ï¼Œæˆ‘æ­£åœ¨åˆ†æä¸­...");
        // Optional: gá»­i vá» server
        const result = await response.json();
        appendChatMessage("bot", result.answer);
        document.getElementById("loadingDialog").style.display = "none";
        // console.log(result)
        // playAmplitudes(result.audio); // â† phÃ¡t láº¡i Ã¢m thanh
        if ("audio_base64" in result){
            playRemoteMP3(result.audio_base64);
        }
      }
    });
  
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    const micBtn = document.getElementById("micBtn");
  
    micBtn.addEventListener("click", async () => {
      if (!isRecording) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
  
        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) {
            audioChunks.push(e.data);
          }
        };
  
        mediaRecorder.onstop = async () => {
          document.getElementById("loadingDialog").style.display = "flex";
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          const formData = new FormData();
          formData.append("audio", audioBlob, "recording.wav");
  
          // appendChatMessage("user", "ğŸ¤ï¼ˆéŸ³è¨Šå·²é€å‡ºï¼‰");
  
          try {
            const response = await fetch("https://em62pxdlbjubuw.api.runpod.ai/upload", {
              method: "POST",
              headers: {
               
              },
              body: formData
            });
  
            const result = await response.text();
  
            // Hiá»ƒn thá»‹ káº¿t quáº£ vÃ  cáº­p nháº­t input
            // appendChatMessage("bot", result);
            document.getElementById("chatInput").value = result;
            document.getElementById("loadingDialog").style.display = "none";
          } catch (err) {
            appendChatMessage("bot", "âŒ éŒ¯èª¤ï¼šç„¡æ³•è¾¨è­˜éŸ³è¨Š");
            document.getElementById("loadingDialog").style.display = "none";
          }
        };
  
        mediaRecorder.start();
        micBtn.innerText = "ğŸ›‘";
        isRecording = true;
      } else {
        mediaRecorder.stop();
        micBtn.innerText = "ğŸ¤";
        isRecording = false;
      }
    });

    function playAmplitudes(amplitudes, sampleRate = 22050) {
      const audioContext = new AudioContext({ sampleRate });
      // const gainFactor = 1; // Báº¡n cÃ³ thá»ƒ chá»‰nh sá»‘ nÃ y náº¿u váº«n quÃ¡ nhá»
    
      // Khuáº¿ch Ä‘áº¡i, nhÆ°ng Ä‘áº£m báº£o váº«n trong [-1, 1]
      // const normalized = amplitudes.map(v => {
      //   let val = v * gainFactor;
      //   return Math.max(-1, Math.min(1, val)); // clamp
      // });
    
      const buffer = audioContext.createBuffer(1, amplitudes.length, sampleRate);
      buffer.copyToChannel(new Float32Array(amplitudes), 0);
    
      const source = audioContext.createBufferSource();
      source.buffer = buffer;
      source.connect(audioContext.destination);
      source.start();
    }
    async function playRemoteMP3(audioBase64) {
      const baseURL = window.location.origin; // VÃ­ dá»¥: "https://myweb.com"
      const audioBlob = new Blob([new Uint8Array(atob(audioBase64).split('').map(char => char.charCodeAt(0)))], { type: 'audio/mp3' });
    
      const audioURL = URL.createObjectURL(audioBlob);
      const audio = new Audio(audioURL);
      audio.play();
    }

    function changeQuestions(){
      let newQuestion;
      const current = suggestBtn.textContent.trim(); // loáº¡i bá» khoáº£ng tráº¯ng
    
      // Lá»c ra táº¥t cáº£ cÃ¢u há»i khÃ¡c vá»›i cÃ¢u hiá»‡n táº¡i
      const filtered = questions.filter(q => q.trim() !== current);
    
      if (filtered.length === 0) {
        console.warn("KhÃ´ng cÃ²n cÃ¢u há»i khÃ¡c Ä‘á»ƒ chá»n.");
        return;
      }
    
      newQuestion = filtered[Math.floor(Math.random() * filtered.length)];
      suggestBtn.textContent = newQuestion;
    }

      // Báº¯t sá»± kiá»‡n click cho cÃ¡c cÃ¢u há»i gá»£i Ã½
  document.querySelectorAll('.suggest-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // console.log(questions)
      const text = btn.textContent;
      document.getElementById("chatInput").value = text;
      document.getElementById("sendBtn").click();
      changeQuestions();
    });
  });
    document.addEventListener("DOMContentLoaded", () => {
      const savedDoctor = localStorage.getItem("selectedDoctor");
      if (savedDoctor) {
        document.getElementById('selectedImg').src = savedDoctor;
        let nameConsultant;
        if (savedDoctor.includes("/male_doctor")) {
            nameConsultant = "è—¥åŠ‘å¸«";
        } else if (savedDoctor.includes("/female_doctor")) {
            nameConsultant = "ç‡Ÿé¤Šå¸«";
        }
        document.getElementById('selectedName').textContent = nameConsultant;
      }else{
        selectCharacter("static/images/male_doctor.jpg")
      }
    });
    document.getElementById("downloadBtn").addEventListener("click", function () {
      const chatLog = document.getElementById("chatLog");
    
      const messages = Array.from(chatLog.getElementsByClassName("chat-message"))
        .map(msg => {
          const role = msg.classList.contains("bot") ? "Bot" : "User";
          const content = msg.innerText || msg.textContent;
          return `${role}: ${content}`;
        })
        .join("\n");
    
      const blob = new Blob([messages], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
    
      const a = document.createElement("a");
      a.href = url;
      a.download = "chatlog.txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

  </script>
</body>
</html>
